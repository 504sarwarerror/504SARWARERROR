<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="ASSETS/favicon.ico" type="image/ico" />
    <title>404</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Courier New", monospace;
        background: #222;
        color: #eee;
        overflow: hidden;
      }
      * {
        box-sizing: border-box;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url("https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExc2hsN3c5MnJuanZoY3g4cnl3cDNlcDlzMW1qbHk0aDhnYWFzN3BndiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KLGfgLXAN6IE0/giphy.gif")
          center center / cover no-repeat;
        opacity: 0.2;
        z-index: 0;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        z-index: 1;
        position: relative;
        padding: 12px;
        max-width: 900px;
        margin: 0 auto;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 80px;
        padding-top: 10px;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .messages::-webkit-scrollbar {
        display: none;
      }

      .msg {
        padding: 10px 12px;
        border-radius: 0;
        max-width: 80%;
        font-size: 14px;
        position: relative;
        overflow-wrap: break-word;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: #fff;
      }

      .msg.mine {
        background: rgba(255, 255, 255, 0.1);
        align-self: flex-end;
      }

      .msg.mine-legacy {
        background: #000;
        color: #fff;
        align-self: flex-end;
        border-left: 3px solid #fff;
      }

      .msg img {
        max-width: 120px;
        max-height: 120px;
        display: block;
        margin-top: 6px;
        border-radius: 0;
      }

      .meta {
        font-size: 11px;
        margin-bottom: 4px;
      }

      .username {
        font-weight: bold;
        display: inline-block;
        background: var(--user-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradientAnim 5s ease infinite;
      }

      @keyframes gradientAnim {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .composer-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 0 10px 10px 10px;
        max-width: 1000px;
        margin: 0 auto;
      }

      .composer {
        display: flex;
        width: 95%;
        gap: 8px;
      }

      .composer input {
        flex: 1;
        padding: 12px;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #fff;
        font-family: inherit;
        font-size: 14px;
      }

      .composer button {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        flex-shrink: 0;
        font-size: 14px;
      }

      .composer button:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .settings-dropdown {
        position: absolute;
        bottom: 65px; /* Adjust as needed */
        right: 10px; /* Aligns with the composer padding */
        background: rgba(0, 0, 0, 0.5); /* More transparent background */
        backdrop-filter: blur(12px); /* Increased blur for a frostier look */
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px;
        z-index: 3;
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 250px;
      }

      .settings-dropdown label {
        font-size: 12px;
        color: #ccc;
      }

      .settings-dropdown input {
        padding: 8px;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-family: inherit;
      }

      .settings-dropdown button {
        padding: 8px;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        font-family: inherit;
        cursor: pointer;
        transition: background 0.2s ease;
        width: 100%;
        margin-top: 5px;
      }

      @media (max-width: 600px) {
        .composer input {
          font-size: 12px;
          padding: 10px;
        }
        .composer button {
          width: 40px;
          height: 40px;
        }
        .msg {
          font-size: 13px;
          max-width: 90%;
        }
      }

      .small-icons {
        text-align: center;
        padding: 5px 0;
        position: relative;
        z-index: 2;
      }
      .small-icons img {
        margin: 0 8px;
        vertical-align: middle;
        max-height: 40px;
      }

      /* Skeleton Loader Styles */
      .skeleton-msg {
        padding: 10px 12px;
        border-radius: 0;
        max-width: 80%;
        background: rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
        height: 60px;
      }

      .skeleton-msg .skeleton-line {
        height: 12px;
        background: rgba(255, 255, 255, 0.1);
        margin-bottom: 8px;
        border-radius: 2px;
      }

      .skeleton-msg .skeleton-line.short {
        width: 40%;
      }

      .skeleton-msg .skeleton-line.long {
        width: 90%;
      }

      .skeleton-msg::before {
        content: "";
        position: absolute;
        top: 0;
        left: -150%;
        width: 150%;
        height: 100%;
        background: linear-gradient(
          to right,
          transparent 0%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 100%
        );
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -150%;
        }
        100% {
          left: 150%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="small-icons">
        <img
          src="https://raw.githubusercontent.com/BrunnerLivio/brunnerlivio/master/images/ie_logo.gif"
          alt="Microsoft Internet Explorer"
        />
        <img
          src="https://raw.githubusercontent.com/fnky/fnky/fnky/img/smile.gif"
          alt="SMILEY"
        />
        <img
          src="https://raw.githubusercontent.com/BrunnerLivio/brunnerlivio/master/images/noframes.gif"
          alt="noframes"
        />
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer-wrapper">
        <div
          id="settingsDropdown"
          class="settings-dropdown"
          style="display: none"
        >
          <label for="usernameInput">Change Username</label>
          <input id="usernameInput" type="text" />
          <button id="saveUsernameBtn" class="composer-button">Save</button>
        </div>
        <div class="composer">
          <input
            id="messageInput"
            type="text"
            placeholder="Type a message..."
          />
          <button id="settingsBtn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
              />
              <circle cx="12" cy="12" r="3" />
            </svg>
          </button>
          <button id="sendBtn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"
              />
              <path d="m21.854 2.147-10.94 10.939" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://jfjozylvsbhsyiyfpacp.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmam96eWx2c2Joc3lpeWZwYWNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzczMTAsImV4cCI6MjA3NDIxMzMxMH0.M9kZUvXvJbY4H1rNp9qK-avTrKBOLifRFmYQByzD0KI";
      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const messagesEl = document.getElementById("messages");
      const sendBtn = document.getElementById("sendBtn");
      const messageInput = document.getElementById("messageInput");
      const settingsBtn = document.getElementById("settingsBtn");
      const settingsDropdown = document.getElementById("settingsDropdown");
      const usernameInput = document.getElementById("usernameInput");
      const saveUsernameBtn = document.getElementById("saveUsernameBtn");

      let mySessionId = localStorage.getItem("chat_session_id");
      let lastMessageTime = 0;
      let lastMessageContent = "";
      const MESSAGE_COOLDOWN = 2000;
      const MAX_MESSAGE_LENGTH = 500;
      const MAX_USERNAME_LENGTH = 25;
      const SPAM_WINDOW = 30000;
      const MAX_MESSAGES_IN_WINDOW = 10;
      let messageTimestamps = [];
      let userTimeoutUntil = 0;
      const SPAM_TIMEOUT_DURATION = 30000;
      const allUserTimestamps = {};

      if (!mySessionId) {
        mySessionId = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("chat_session_id", mySessionId);
      }

      function randomUsername() {
        const adjectives = [
          "Retro",
          "Ghost",
          "Cyber",
          "Pixel",
          "Neon",
          "Shadow",
          "Glitch",
          "Toxic",
          "Quantum",
          "Mad",
          "Broken",
          "Void",
          "Viral",
          "Feral",
          "Cha0s",
          "Null",
          "Error",
          "Fractured",
        ];

        const nouns = [
          "Tiger",
          "Falcon",
          "Ninja",
          "Dragon",
          "Panda",
          "Freak",
          "Virus",
          "Anon",
          "Corpse",
          "Reaper",
          "Dumpster",
          "Ghoul",
          "Hack",
          "Phantom",
          "Wraith",
          "Blob",
          "Overload",
        ];

        const symbols = ["_", "-", "~", "!", "@", "#", "$", "%", "^", "∆", "?"];
        const endings = ["404", "666", "XxX", "Ω", ".exe", "!!", "∞", "?!"];

        const leetify = (word) =>
          word.replace(
            /[aAeEiIoOsStT]/g,
            (c) =>
              ({ a: "4", e: "3", i: "1", o: "0", s: "5", t: "7" }[
                c.toLowerCase()
              ] || c)
          );

        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const sym = symbols[Math.floor(Math.random() * symbols.length)];
        const end = endings[Math.floor(Math.random() * endings.length)];
        const number = Math.floor(Math.random() * 999);

        const style = Math.random();
        let name;
        if (style < 0.25) name = leetify(adj) + sym + leetify(noun) + end;
        else if (style < 0.5)
          name = adj.toUpperCase() + sym + noun.toLowerCase() + number;
        else if (style < 0.75)
          name = adj.toLowerCase() + noun.toUpperCase() + sym + end;
        else
          name =
            leetify(adj) +
            leetify(noun) +
            symbols[Math.floor(Math.random() * symbols.length)] +
            number;

        return name;
      }

      for (let i = 0; i < 10; i++) {
        console.log(randomUsername());
      }

      function generateGradientForUsername(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++)
          hash = username.charCodeAt(i) + ((hash << 5) - hash);
        const hue1 = Math.abs(hash % 360);
        const hue2 = (hue1 + 72) % 360;
        return `linear-gradient(90deg, hsl(${hue1}, 80%, 60%), hsl(${hue2}, 80%, 60%), hsl(${hue1}, 80%, 60%))`;
      }

      let myUsername =
        localStorage.getItem("chat_username") || randomUsername();
      localStorage.setItem("chat_username", myUsername);

      const usernameGradients = {};
      function getGradient(username) {
        if (!usernameGradients[username])
          usernameGradients[username] = generateGradientForUsername(username);
        return usernameGradients[username];
      }

      function addMessage(item, mine = false) {
        const outer = document.createElement("div");
        outer.dataset.userId = item.user || mySessionId;
        outer.dataset.content = item.content;
        outer.className = "msg" + (mine ? " mine" : "");

        const meta = document.createElement("div");
        meta.className = "meta";
        const usernameSpan = document.createElement("span");
        usernameSpan.className = "username";
        let username = item.username || "Anonymous";
        if (username.length > MAX_USERNAME_LENGTH) {
          username = username.substring(0, MAX_USERNAME_LENGTH) + "...";
        }
        usernameSpan.textContent = username;

        usernameSpan.style.setProperty(
          "--user-gradient",
          getGradient(item.username || "Anon")
        );
        usernameSpan.style.backgroundSize = "300% 300%";
        meta.appendChild(usernameSpan);
        meta.appendChild(
          document.createTextNode(
            " " + new Date(item.created_at || Date.now()).toLocaleTimeString()
          )
        );

        const body = document.createElement("div");
        const sanitizedContent = (item.content || "")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        const finalContent = sanitizedContent.replace(
          /&lt;img src="https:\/\/media\.giphy\.com\/media\/l0MYt5jPR6QX5pnqM\/giphy\.gif" \/&gt;/g,
          '<img src="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" />'
        );
        body.innerHTML = finalContent;
        outer.appendChild(meta);
        outer.appendChild(body);
        messagesEl.appendChild(outer);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function showSkeletonLoader() {
        messagesEl.innerHTML = ""; // Clear existing content
        for (let i = 0; i < 15; i++) {
          const skeleton = document.createElement("div");
          skeleton.className = "skeleton-msg";
          skeleton.innerHTML = `
            <div class="skeleton-line long"></div>
          `;
          if (Math.random() > 0.5) {
            skeleton.style.maxWidth = "70%";
          }
          messagesEl.appendChild(skeleton);
        }
      }

      // Function to load messages from Supabase
      async function loadMessages() {
        showSkeletonLoader();
        try {
          const { data, error } = await supabaseClient
            .from("messages")
            .select("*")
            .order("created_at", { ascending: true });

          messagesEl.innerHTML = ""; // Clear skeletons

          if (error) {
            console.error("Error loading messages from Supabase:", error);
            messagesEl.innerHTML = `<div class="msg">Error loading messages.</div>`;
            return;
          }
          data?.forEach((msg) => addMessage(msg, msg.user === mySessionId));
        } catch (e) {
          console.error(
            "Network or unexpected error during message loading:",
            e
          );
          messagesEl.innerHTML = `<div class="msg">Network error. Could not load chat.</div>`;
        }
      }

      async function sendMessage() {
        // Re-enabled: Check if the user is on a timeout.
        if (userTimeoutUntil > Date.now()) {
          const remaining = Math.ceil((userTimeoutUntil - Date.now()) / 1000);
          console.warn(
            `You are on a timeout for spamming. Please wait ${remaining} seconds.`
          );
          messageInput.placeholder = `Timeout for ${remaining}s...`;
          return;
        }
        messageInput.placeholder = "Type a message...";

        const now = Date.now();
        // Re-enabled: Check for message cooldown.
        if (now - lastMessageTime < MESSAGE_COOLDOWN) {
          console.warn(
            "Rate limit exceeded. Please wait before sending another message."
          );
          return;
        }

        messageTimestamps = messageTimestamps.filter(
          (timestamp) => now - timestamp < SPAM_WINDOW
        );

        // Re-enabled: Check for message velocity (spam window).
        if (messageTimestamps.length >= MAX_MESSAGES_IN_WINDOW) {
          console.warn(
            "Spam detection: Too many messages sent. Timed out for 30 seconds."
          );
          userTimeoutUntil = now + SPAM_TIMEOUT_DURATION;
          messageTimestamps = [];
          return;
        }

        let text = messageInput.value.trim();

        // Check if the message is identical to the last one sent.
        if (text && text === lastMessageContent) {
          console.warn("Duplicate message detected. Not sending.");
          // Optionally provide user feedback
          messageInput.placeholder = "Please don't send duplicate messages.";
          return;
        }

        const chaoticText = text.replace(
          /gif/i,
          '<img src="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" />'
        );

        if (text.length > MAX_MESSAGE_LENGTH) {
          text = text.substring(0, MAX_MESSAGE_LENGTH) + "... (truncated)";
        }

        // Construct the message payload
        const messagePayload = {
          user: mySessionId,
          username: myUsername,
          content: chaoticText,
          created_at: new Date().toISOString(),
        };

        // Disable the input and button to prevent sending another message
        sendBtn.disabled = true;
        messageInput.disabled = true;
        messageInput.placeholder = "Sending...";

        try {
          // Attempt to insert the message into Supabase
          const { error } = await supabaseClient
            .from("messages")
            .insert([messagePayload]);

          if (error) {
            console.error("Error inserting message into Supabase:", error);
            messageInput.placeholder = "Failed to send. Try again.";
            // You might want to display a user-friendly error message here
            return; // Stop execution if insertion failed
          }

          // On success, add the message locally and clear the input
          addMessage(messagePayload, true);
          messageInput.value = "";
          lastMessageTime = now;
          lastMessageContent = text;
          messageTimestamps.push(now);
        } catch (e) {
          console.error(
            "Network or unexpected error during message insertion:",
            e
          );
          messageInput.placeholder = "Network error. Please check connection.";
        } finally {
          // Re-enable the input and button regardless of success or failure
          sendBtn.disabled = false;
          messageInput.disabled = false;
          if (document.activeElement !== messageInput) {
            messageInput.focus();
          }
          // Restore placeholder only if it wasn't set to an error message
          if (messageInput.placeholder.includes("...")) {
            messageInput.placeholder = "Type a message...";
          }
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      settingsBtn.addEventListener("click", () => {
        const isHidden = settingsDropdown.style.display === "none";
        settingsDropdown.style.display = isHidden ? "flex" : "none";
        if (isHidden) {
          usernameInput.value = myUsername;
          usernameInput.focus();
        }
      });

      saveUsernameBtn.addEventListener("click", () => {
        const newUsername = usernameInput.value.trim();
        if (newUsername) {
          myUsername = newUsername;
          localStorage.setItem("chat_username", myUsername);
          settingsDropdown.style.display = "none";
        }
      });
      const channel = supabaseClient
        .channel("chat-room", { config: { presence: { key: mySessionId } } })
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "messages" },
          (payload) => {
            const newUserMessage = payload.new;
            // This prevents your own messages from appearing a second time.
            if (newUserMessage.user === mySessionId) return;
            const now = Date.now();
            const userId = newUserMessage.user;
            if (!allUserTimestamps[userId]) {
              allUserTimestamps[userId] = [];
            }

            allUserTimestamps[userId] = allUserTimestamps[userId].filter(
              (timestamp) => now - timestamp < SPAM_WINDOW
            );

            // Re-enabled: Hide messages from other users detected as spammers.
            if (allUserTimestamps[userId].length >= MAX_MESSAGES_IN_WINDOW) {
              console.warn(`Hiding spam message from user: ${userId}`);
              return;
            }

            allUserTimestamps[userId].push(now);
            addMessage(newUserMessage);
          }
        )
        .subscribe();

      loadMessages();
    </script>
  </body>
</html>
